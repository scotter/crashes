<!DOCTYPE html>
<meta charset="utf-8">
<title>Annual Average Daily Traffic - Allegheny County 2010-2014</title>

  <script src="//code.jquery.com/jquery-1.12.1.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <script src="./js/L.D3SvgOverlay.min.js"></script>

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">


<style>

  body {
    padding: 0;
    margin: 0;
  }

  html, body, #map {
    height: 100%;
    width: 100%;
  }

  #blurb {
    position: absolute;
    width: 100%;
    bottom: 0px;
    left: 0px;
    font-size: 16px;
    background-color: white;
    padding: 8px;
    opacity: 0.9;
  }

  .road {
    fill: none;
    stroke-linejoin: round;
    stroke-linecap: round;
  }

</style>

<body>

  <div id="map"></div>

  <div id="blurb">
    Road segments colored by their Fatal and Major Injury <a href="http://safety.fhwa.dot.gov/local_rural/training/fhwasa1109/app_c.cfm" target="_blank">rate per Vehicle Miles Traveled</a>. Hovering on segment shows the associated crashes in from 2010 - 2014. This is very much a work in progress.
  </div>



  <script>

    var map = new L.Map('map', {
            center: [40.449690349293654, -79.96192932128906], 
            zoom: 11
          }),
        tileLayer = new L.TileLayer('http://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png');

    tileLayer.setOpacity(1);

    map.addLayer(tileLayer);

    map._initPathRoot();


    queue()
      .defer(d3.json, './data/road_stats.json')
      .defer(d3.csv, './data/crashes.csv')
      .await(function(error, roads, crashes) { 
        if (error) throw error;
        console.log(roads);
        console.log(crashes);

        var colors = ['#fee0d2','#fcbba1','#fc9272','#fb6a4a','#ef3b2c','#cb181d','#a50f15','#67000d'];

        roads.features.forEach(function(d){
          var value = (+d.properties.fatal_count + +d.properties.maj_inj_count) / ( 100000000 * +d.properties.dly_vmt_avg);
          d.properties.value = value == 0 ? 0 : Math.log(value);
        });


        roads.features = roads.features.sort(function(a,b){
          return d3.descending(a.properties.value, b.properties.value);
        });

        window.has_crashes = roads.features.filter(function(d){
          return d.properties.value != 0;
        })

        var extent = d3.extent(has_crashes.map(function(d){
          return d.properties.value;
        }));

        var quantize = d3.scale.quantize()
          .domain(extent)
          .range(d3.range(8).map(function(i) { return colors[i] }));

        var width_scale = d3.scale.linear()
          .domain(extent)
          .range([0.5, 5]);


        var svg = L.d3SvgOverlay(function(selection, projection){

          var crashes_g = selection.selectAll('.crash');
          if(crashes_g.empty()){
            crashes_g = selection.append('g')
              .attr('class','crashes')

          crashes = crashes.filter(function(d){
            return (+d.fatal_count + +d.maj_inj_count) > 0;
          });

          var circles = crashes_g.selectAll('circle')
              .data(crashes);

          circles.enter().append('circle')
            .attr('class', function(d){
              return 'crash c-' + d.road_stats_id
            })
            .attr('r', function(d){
              return +d.fatal_count + 5;
            })
            .attr('cx', function(d){
              var p = projection.latLngToLayerPoint({ lon: +d.dec_long, lat: +d.dec_lat });
              return p.x;
            })
            .attr('cy', function(d){
              var p = projection.latLngToLayerPoint({ lon: +d.dec_long, lat: +d.dec_lat });
              return p.y;
            })         
            .style('fill', function(){
              return 'red';
            })
            .style('opacity', 0);
          }


          var roads_g = selection.selectAll('.road');
          if(roads_g.empty()){
            roads_g = selection.append('g')
              .attr('class','roads')

            var road_paths = roads_g.selectAll('path')
              .data(roads.features);

            road_paths.enter().append('path')
              .attr('class', 'road')
              .attr('id', function(d){
                return 'road-' + d.properties.id;
              })
              .attr('d', d3.geo.path()
                  .projection(function(l){
                    var p = projection.latLngToLayerPoint({ lon: l[0], lat:  l[1] });
                    return [p.x,p.y];
                  })
                )
              .attr('stroke', function(d){
                return d.properties.value !== 0 ? quantize( d.properties.value ) : '#efefef';
              })
              .attr('stroke-width', function(d){
                return d.properties.value !== 0 ? width_scale( +d.properties.value ) : 0.5;
              })
              .on('mouseenter', function(d){
                var self = this,
                    other_roads = d3.selectAll('path.road').filter(function(d,i) {
                      return (this !== self);
                    });
                d3.select(this).attr('opacity', 0.5);
                other_roads.attr('opacity', 0.1);

                crashes_g.selectAll('circle.c-' + d.properties.id)
                  .style('opacity', 1)

              })
              .on('mouseleave', function(){
                d3.selectAll('path.road').attr('opacity', 1);
                crashes_g.selectAll('circle')
                  .style('opacity', 0)
              });
          }

        });

        svg.addTo(map);
        /* 
          var bounds = d3.geo.bounds(has_crashes[10].geometry)
          map.fitBounds( [ [bounds[0][1], bounds[0][0]], [bounds[1][1], bounds[1][0]] ], { animate: true, duration: 10, maxZoom: 15 })
        */
 
      });

  </script>
